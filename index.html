<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEAR CLASSROOM TIMER!</title>

<style>
body{
  margin:0;
  padding:24px;
  background:#f6f8fb;
  font-family:system-ui;
}
.container{max-width:1400px;margin:auto}
.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.1);
  margin-bottom:20px;
}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
input,button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #d1d5db;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}

.timer-card{
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
  margin-top:16px;
}

.bar-frame{
  position:relative;
  height:44px;
  background:#e5e7eb;
  border-radius:12px;
  overflow:hidden;
}

.agenda-layer{
  position:absolute;
  inset:0;
  z-index:2;
}

.progress{
  position:absolute;
  inset:0;
  width:0%;
  background:rgba(0,0,0,.35);
  z-index:3;
  pointer-events:none;
}

.agenda-item{
  position:absolute;
  top:6px;
  height:32px;
  border-radius:8px;
  color:#fff;
  font-size:13px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
  user-select:none;
}

.labels{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
  font-weight:700;
}

.now{
  margin-top:10px;
  padding:8px 12px;
  border-radius:10px;
  font-weight:800;
  color:#fff;
  background:#111827;
}

/* PROJECTOR */
.projector{
  background:#0f172a;
  color:#fff;
  padding:48px;
  min-height:100vh;
}
.projector h1{font-size:64px;margin-bottom:28px}
.projector .bar-frame{height:90px;margin-bottom:12px}
.projector .progress{background:rgba(255,255,255,.35)}
.projector .agenda-item{
  top:12px;
  height:66px;
  font-size:28px;
}
.projector .labels{font-size:28px}
.projector .now-projector{
  margin-top:30px;
  font-size:40px;
  font-weight:900;
}
.projector .agenda-title{
  margin-top:18px;
  font-size:36px;
  font-weight:800;
}
.projector .agenda-progress{
  position:absolute;
  inset:0;
}
</style>
</head>

<body>
<div class="container">
<div class="card">

<h2>Create a new timer for each class period. Add class agenda items with time limits. Drag to reorder. Projector mode displsays the timer and current agenda. Be intentional with your time!</h2>
<div class="controls">
  <input id="timerName" placeholder="Timer name">
  <input id="timerStart" type="time">
  <input id="timerEnd" type="time">
  <button onclick="addTimer()">Add Timer</button>
  <button onclick="saveAll()">Save</button>
  <button onclick="clearAll()">Clear</button>
</div>

<div id="timers"></div>

</div>
</div>

<script>
/* ===== CORE (STABLE) ===== */

let timers=[];
const timersEl=document.getElementById('timers');

function toMin(t){
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}

function addTimer(){
  if(!timerName.value||!timerStart.value||!timerEnd.value) return;
  timers.push({
    id:crypto.randomUUID(),
    name:timerName.value,
    start:timerStart.value,
    end:timerEnd.value,
    agendas:[]
  });
  render();
}

function render(){
  timersEl.innerHTML='';
  timers.forEach(renderTimer);
}

function renderTimer(t){
  const startM=toMin(t.start);
  const endM=toMin(t.end);
  const total=endM-startM;

  const card=document.createElement('div');
  card.className='timer-card';

  card.innerHTML=`
    <h3>${t.name} (${t.start}–${t.end})</h3>
    <div class="bar-frame">
      <div class="agenda-layer"></div>
      <div class="progress"></div>
    </div>
    <div class="labels">
      <div class="elapsed"></div>
      <div class="remaining"></div>
    </div>
    <div class="now">Now Happening — None</div>
    <div class="controls" style="margin-top:10px">
      <input placeholder="Agenda name">
      <input type="number" placeholder="Minutes">
      <input type="color" value="#f97316">
      <button>Add Agenda</button>
      <button>Projector Mode</button>
    </div>
  `;

  timersEl.appendChild(card);

  const agendaLayer=card.querySelector('.agenda-layer');
  const progress=card.querySelector('.progress');
  const elapsedEl=card.querySelector('.elapsed');
  const remainingEl=card.querySelector('.remaining');
  const nowEl=card.querySelector('.now');
  const btns=card.querySelectorAll('button');

  btns[0].onclick=()=>{
    const i=card.querySelectorAll('input');
    t.agendas.push({
      label:i[0].value,
      mins:+i[1].value,
      color:i[2].value,
      offset:t.agendas.reduce((s,a)=>s+a.mins,0)
    });
    render();
  };

  btns[1].onclick=()=>{
    localStorage.setItem('projectorTimer',JSON.stringify(t));
    window.open(location.pathname+'#projector','_blank');
  };

  function drawAgendas(){
    agendaLayer.innerHTML='';
    t.agendas.forEach(a=>{
      const el=document.createElement('div');
      el.className='agenda-item';
      el.textContent=a.label;
      el.style.background=a.color;
      el.style.width=(a.mins/total*100)+'%';
      el.style.left=(a.offset/total*100)+'%';
      agendaLayer.appendChild(el);
      enableDrag(el,a);
    });
  }

  function enableDrag(el,a){
    let sx,so;
    el.onpointerdown=e=>{
      sx=e.clientX; so=a.offset;
      el.setPointerCapture(e.pointerId);
      el.onpointermove=ev=>{
        a.offset=Math.max(0,Math.min(total-a.mins, so+(ev.clientX-sx)*(total/card.offsetWidth)));
        el.style.left=(a.offset/total*100)+'%';
      };
      el.onpointerup=()=>{
        el.onpointermove=null;
        snap();
        render();
      };
    };
  }

  function snap(){
    t.agendas.sort((a,b)=>a.offset-b.offset);
    let c=0;
    t.agendas.forEach(a=>{a.offset=c;c+=a.mins});
  }

  function tick(){
    const n=new Date();
    const nowM=n.getHours()*60+n.getMinutes()+n.getSeconds()/60;
    const e=Math.max(0,Math.min(total,nowM-startM));
    progress.style.width=(e/total*100)+'%';
    elapsedEl.textContent=e.toFixed(1)+' min elapsed';
    remainingEl.textContent=(total-e).toFixed(1)+' min remaining';
    const cur=t.agendas.find(a=>e>=a.offset&&e<a.offset+a.mins);
    nowEl.textContent=cur?'Now Happening — '+cur.label:'Now Happening — None';
    nowEl.style.background=cur?cur.color:'#111827';
  }

  drawAgendas();
  tick();
  setInterval(tick,1000);
}

function saveAll(){
  localStorage.setItem('multiAgendaTimers',JSON.stringify(timers));
}
function clearAll(){
  localStorage.clear();
  location.reload();
}
function load(){
  const d=localStorage.getItem('multiAgendaTimers');
  if(d){timers=JSON.parse(d);render();}
}

/* ===== PROJECTOR (READ-ONLY, VISUAL MATCH) ===== */

if(location.hash==='#projector'){
  document.body.innerHTML='';
  const t=JSON.parse(localStorage.getItem('projectorTimer'));
  const startM=toMin(t.start);
  const endM=toMin(t.end);
  const total=endM-startM;

  const p=document.createElement('div');
  p.className='projector';
  p.innerHTML=`
    <h1>${t.name}</h1>

    <div class="bar-frame">
      <div class="agenda-layer" id="pAgenda"></div>
      <div class="progress" id="pProgress"></div>
    </div>
    <div class="labels">
      <div></div>
      <div id="pRemain"></div>
    </div>

    <div class="now-projector" id="nowText">NOW HAPPENING —</div>

    <div id="agendaBlock" style="display:none">
      <div class="agenda-title" id="agendaTitle"></div>
      <div class="bar-frame">
        <div class="agenda-progress" id="agendaProgress"></div>
      </div>
      <div class="labels">
        <div></div>
        <div id="agendaRemain"></div>
      </div>
    </div>
  `;
  document.body.appendChild(p);

  // draw agenda segments in main projector bar
  t.agendas.forEach(a=>{
    const el=document.createElement('div');
    el.className='agenda-item';
    el.textContent=a.label;
    el.style.background=a.color;
    el.style.width=(a.mins/total*100)+'%';
    el.style.left=(a.offset/total*100)+'%';
    pAgenda.appendChild(el);
  });

  setInterval(()=>{
    const n=new Date();
    const nowM=n.getHours()*60+n.getMinutes()+n.getSeconds()/60;
    const e=Math.max(0,Math.min(total,nowM-startM));

    pProgress.style.width=(e/total*100)+'%';
    pRemain.textContent=(total-e).toFixed(1)+' min remaining';

    const cur=t.agendas.find(a=>e>=a.offset&&e<a.offset+a.mins);

    if(cur){
      nowText.textContent='NOW HAPPENING — '+cur.label;
      agendaBlock.style.display='block';
      agendaTitle.textContent=cur.label;
      const ae=e-cur.offset;
      agendaProgress.style.width=(ae/cur.mins*100)+'%';
      agendaProgress.style.background=cur.color;
      agendaRemain.textContent=(cur.mins-ae).toFixed(1)+' min remaining';
    }else{
      nowText.textContent='NOW HAPPENING —';
      agendaBlock.style.display='none';
    }
  },1000);

}else{
  load();
}
</script>
</body>
</html>

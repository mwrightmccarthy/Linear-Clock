<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Input Start and End Times. Add Agenda Items. Work Your Plan!</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7a90;}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:20px;background:var(--bg);display:flex;justify-content:center;}
  .wrap{width:100%;max-width:1100px;}
  h1{margin:0 0 6px;font-size:20px;text-align:center}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06);}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  input,select,button{padding:8px;border-radius:8px;border:1px solid #e6eef8;font-size:14px}
  input[type="color"]{padding:0;width:44px;height:36px;border:0}
  button{background:#0b66ff;color:#fff;border:0;cursor:pointer}
  .timers{display:flex;flex-direction:column;gap:16px;margin-top:12px}
  .timer{padding:12px;border-radius:8px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.04);position:relative}
  .timer-head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .meta{color:var(--muted);font-size:13px}
  .bar-wrap{padding:12px 8px 6px}
  .ticks-top{position:relative;height:22px;margin-bottom:6px}
  .tick-top{position:absolute;top:8px;width:1px;height:10px;background:#c0c9d6}
  .tick-top-label{position:absolute;top:0;transform:translateX(-50%);font-size:11px;color:#4b5868}
  .bar-frame{position:relative;background:#eef2f7;border-radius:8px;overflow:visible}
  .bar{height:var(--height,36px);border-radius:6px;position:relative;background:#f6f9fc}
  .bar-fill{position:absolute;left:0;top:0;height:100%;width:0;border-radius:6px 0 0 6px;transition:width .15s linear}
  .bar-text{position:absolute;left:8px;top:0;bottom:0;display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-weight:700;color:#fff;pointer-events:none;font-size:14px}
  .bar-text .right{color:#000}
  .ticks-bottom{position:relative;height:36px;margin-top:10px}
  .tick-btm{position:absolute;bottom:16px;width:1px;height:10px;background:#d2d9e2}
  .tick-btm-label{position:absolute;bottom:0;transform:translateX(-50%);font-size:11px;color:#4b5868}
  .mins{display:flex;justify-content:space-between;margin-top:8px;font-weight:700}
  .agenda-panel{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .agenda-inputs input[type="text"]{min-width:160px}
  .agenda-item{position:absolute;top:-30px;transform:translateX(0%);padding:6px 8px;border-radius:6px;color:#fff;font-size:13px;cursor:grab;white-space:nowrap;box-shadow:0 3px 8px rgba(0,0,0,0.12)}
  .agenda-line{position:absolute;top:-6px;width:2px;height:calc(100% + 12px);}
  .small{font-size:13px;color:var(--muted);margin-top:8px}
  .btn-ghost{background:#fff;color:#0b66ff;border:1px solid #cfe0ff;padding:8px 10px;border-radius:8px;cursor:pointer}
  .flex-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media (max-width:720px){ .bar-text{font-size:12px} .agenda-inputs input[type="text"]{min-width:120px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Classroom Timer. Add Start & End Times. Add and Stack Agenda Items. Get Things Done!</h1>
  <div class="card" role="region" aria-label="Create timer">
    <div class="controls">
      <input id="timerName" type="text" placeholder="Timer name (e.g., Period 1)" />
      <input id="timerStart" type="time" />
      <input id="timerEnd" type="time" />
      <input id="timerColor" type="color" value="#3b82f6" title="Bar color"/>
      <input id="timerHeight" type="number" value="36" min="12" max="120" title="Height (px)"/>
      <button id="addTimer">Add Timer</button>
      <button id="saveBtn" class="btn-ghost">Save</button>
      <button id="loadBtn" class="btn-ghost">Load</button>
      <button id="clearBtn" class="btn-ghost">Clear</button>
    </div>
    <div class="small">Create a timer, then add agenda items by specifying their duration (minutes). Agenda widths are proportional to their duration and are draggable inside the timer.</div>
    <div id="timers" class="timers" aria-live="polite"></div>
  </div>
</div>

<script>
function timeToMinutes(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
function minutesToHM(min){ min = Math.round(min); min = ((min%1440)+1440)%1440; const h = Math.floor(min/60); const m = min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function format12(hm){ const [h,m]=hm.split(':').map(Number); const am = h<12; const hh = ((h+11)%12)+1; return `${hh}:${String(m).padStart(2,'0')} ${am?'AM':'PM'}`; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function uid(prefix){ return prefix+'_'+Math.random().toString(36).slice(2,9); }

let state = { timers: [] };

function saveState(){ localStorage.setItem('linearTimersV2', JSON.stringify(state)); alert('Saved locally'); }
function loadState(){ const s = localStorage.getItem('linearTimersV2'); if(s){ state = JSON.parse(s); renderAll(); alert('Loaded'); } else alert('No saved data'); }
function clearAll(){ if(!confirm('Clear all?')) return; state = {timers:[]}; renderAll(); localStorage.removeItem('linearTimersV2'); }

function addTimerFromForm(){
  const name = document.getElementById('timerName').value.trim();
  const start = document.getElementById('timerStart').value;
  const end = document.getElementById('timerEnd').value;
  const color = document.getElementById('timerColor').value;
  const height = Number(document.getElementById('timerHeight').value) || 36;
  if(!name || !start || !end){ alert('Name, start and end required'); return; }
  const s = timeToMinutes(start), e = timeToMinutes(end);
  if(s===e){ alert('Start and end cannot be the same'); return; }
  const id = uid('t');
  state.timers.unshift({ id,name,start,end,s,e,color,height,agenda:[] });
  renderAll();
  document.getElementById('timerName').value='';
}

function removeTimer(id){ if(!confirm('Remove timer?')) return; state.timers = state.timers.filter(t=>t.id!==id); renderAll(); }

function addAgenda(timerId, label, duration, color){
  const timer = state.timers.find(t=>t.id===timerId); if(!timer) return;
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  if(duration <=0 || duration > dur){ alert('Duration must be >0 and <= timer duration'); return; }
  const aid = uid('a');
  timer.agenda.push({ id:aid, label, duration, color, offsetPct:0 });
  renderAll();
}

function makeAgendaDraggable(el, timer){
  let dragging=false, barRect=null, itemWidth=0;
  el.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    dragging=true;
    el.setPointerCapture && el.setPointerCapture(ev.pointerId);
    barRect = el.parentElement.getBoundingClientRect();
    itemWidth = el.offsetWidth;
  });
  window.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    const clientX = ev.clientX;
    let x = clientX - barRect.left - (itemWidth/2);
    const maxLeft = barRect.width - itemWidth;
    x = clamp(x, 0, maxLeft);
    const pct = (x / barRect.width) * 100;
    el.style.left = pct + '%';
    const aid = el.dataset.aid;
    const agenda = timer.agenda.find(a=>a.id===aid);
    if(agenda){ agenda.offsetPct = pct; }
  });
  window.addEventListener('pointerup', (ev)=>{ dragging=false; try{ el.releasePointerCapture && el.releasePointerCapture(ev.pointerId);}catch(e){} });
}

function renderTicksTop(container){
  container.innerHTML='';
  for(let i=0;i<=10;i++){
    const pct = i*10;
    const tick = document.createElement('div'); tick.className='tick-top'; tick.style.left = pct + '%'; container.appendChild(tick);
    const lbl = document.createElement('div'); lbl.className='tick-top-label'; lbl.style.left = pct + '%'; lbl.textContent = pct + '%'; container.appendChild(lbl);
  }
}
function renderTicksBottom(container, timer){
  container.innerHTML='';
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  const steps = Math.ceil(dur/5);
  for(let i=0;i<=steps;i++){
    const minutesFromStart = i*5;
    const pct = (minutesFromStart / dur) * 100;
    const tick = document.createElement('div'); tick.className='tick-btm'; tick.style.left = pct + '%'; container.appendChild(tick);
    if(i%3===0){ const lbl = document.createElement('div'); lbl.className='tick-btm-label'; lbl.style.left = pct + '%'; 
      let labelMin = (timer.s + minutesFromStart) % 1440; const hh = Math.floor(labelMin/60); const mm = labelMin%60;
      const ampm = hh<12?'AM':'PM'; const dispH = ((hh+11)%12)+1; lbl.textContent = `${dispH}:${String(mm).padStart(2,'0')}${ampm}`;
      container.appendChild(lbl);
    }
  }
}

function renderAgendas(timer, barElement){
  Array.from(barElement.querySelectorAll('.agenda-item, .agenda-line')).forEach(n=>n.remove());
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  timer.agenda.forEach(a=>{
    const widthPct = (a.duration / dur) * 100;
    const leftPct = clamp(a.offsetPct, 0, 100 - widthPct);
    const item = document.createElement('div');
    item.className = 'agenda-item';
    item.dataset.aid = a.id;
    item.style.left = leftPct + '%';
    item.style.width = `calc(${widthPct}% - 2px)`;
    item.style.background = a.color;
    item.innerHTML = `<span>${escapeHtml(a.label)} (${a.duration}m)</span>`;
    barElement.appendChild(item);
    const line = document.createElement('div'); line.className='agenda-line'; line.style.left = (leftPct + widthPct/2) + '%'; line.style.color = a.color; barElement.appendChild(line);
    makeAgendaDraggable(item, timer);
  });
}

function renderAll(){
  const container = document.getElementById('timers'); container.innerHTML='';
  state.timers.forEach(timer=>{
    const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
    const outer = document.createElement('div'); outer.className='timer'; outer.id = timer.id;
    outer.innerHTML = `
      <div class="timer-head">
        <div>
          <div style="font-weight:700">${escapeHtml(timer.name)}</div>
          <div class="meta">${format12(timer.start)} → ${format12(timer.end)} • ${dur} min</div>
        </div>
        <div class="flex-row">
          <button class="btn-ghost" onclick="removeTimer('${timer.id}')">Remove</button>
          <button class="btn-ghost" onclick="openTimerWindow('${timer.id}')">Open display</button>
        </div>
      </div>
      <div class="bar-wrap">
        <div class="ticks-top" id="${timer.id}_top"></div>
        <div class="bar-frame" style="--height:${timer.height}px">
          <div class="bar" id="${timer.id}_bar" style="height:${timer.height}px">
            <div class="bar-fill" id="${timer.id}_fill" style="background:${timer.color};"></div>
            <div class="bar-text" id="${timer.id}_text"><div id="${timer.id}_left"></div><div class="right" id="${timer.id}_right"></div></div>
          </div>
        </div>
        <div class="ticks-bottom" id="${timer.id}_bottom"></div>
        <div class="mins"><div id="${timer.id}_gone">0 min gone</div><div id="${timer.id}_leftmin">0 min left</div></div>

        <div class="agenda-panel">
          <div class="agenda-inputs flex-row">
            <input type="text" id="${timer.id}_agenda_label" placeholder="Agenda label" />
            <input type="number" id="${timer.id}_agenda_dur" placeholder="Minutes" style="width:110px" />
            <input type="color" id="${timer.id}_agenda_color" value="#d33a3a" />
            <button onclick="handleAddAgenda('${timer.id}')">Add Agenda</button>
          </div>
        </div>
      </div>
    `;
    container.appendChild(outer);
    renderTicksTop(document.getElementById(timer.id + '_top'));
    renderTicksBottom(document.getElementById(timer.id + '_bottom'), timer);
    const barEl = document.getElementById(timer.id + '_bar');
    renderAgendas(timer, barEl);
  });
  updateAll();
}

function handleAddAgenda(timerId){
  const label = document.getElementById(timerId + '_agenda_label').value.trim();
  const dur = Number(document.getElementById(timerId + '_agenda_dur').value);
  const color = document.getElementById(timerId + '_agenda_color').value;
  if(!label || !dur || isNaN(dur)){ alert('Label + duration required'); return; }
  addAgenda(timerId, label, dur, color);
  document.getElementById(timerId + '_agenda_label').value='';
  document.getElementById(timerId + '_agenda_dur').value='';
  document.getElementById(timerId + '_agenda_color').value='#d33a3a';
}

function openTimerWindow(timerId){
  const timer = state.timers.find(t=>t.id===timerId);
  if(!timer) return;
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  let agendasHtml='';
  timer.agenda.forEach(a=>{
    const widthPct = (a.duration / dur) * 100;
    const leftPct = clamp(a.offsetPct, 0, 100 - widthPct);
    agendasHtml += `<div style="position:absolute;left:${leftPct}%;width:${widthPct}%;top:-30px;background:${a.color};color:#fff;padding:6px;border-radius:6px;text-align:center;transform:translateX(0%);font-weight:700;">${escapeHtml(a.label)} (${a.duration}m)</div>`;
    agendasHtml += `<div style="position:absolute;left:${leftPct + widthPct/2}%;width:2px;height:calc(100% + 12px);background:${a.color};top:-6px"></div>`;
  });
  const html = `
  <!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${timer.name} — Display</title>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:Arial;display:flex;align-items:center;justify-content:center;height:100vh}
    .frame{width:90%;max-width:1200px}
    .bar-frame{position:relative;background:#222;border-radius:10px;padding:24px}
    .bar{height:${timer.height}px;background:#333;border-radius:8px;position:relative;overflow:visible}
    .bar-fill{position:absolute;left:0;top:0;height:100%;background:${timer.color};width:0}
    .bar-text{position:absolute;left:16px;top:0;bottom:0;display:flex;align-items:center;color:#fff;font-weight:700;justify-content:space-between;padding:0 16px}
  </style></head><body><div class="frame"><h2 style="color:#fff">${escapeHtml(timer.name)}</h2><div class="bar-frame"><div class="bar" id="bar">${agendasHtml}<div class="bar-fill" id="fill"></div><div class="bar-text" id="text"><div id="L"></div><div id="R"></div></div></div></div></div>
  <script>
    const dur = ${dur};
    function update(){
      const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
      let since = (nowMin - ${timer.s} + 1440)%1440; if(since>dur) since = dur;
      const pct = Math.max(0,Math.min(100,(since/dur)*100));
      document.getElementById('fill').style.width = pct + '%';
      document.getElementById('L').textContent = pct.toFixed(1) + '%';
      document.getElementById('R').textContent = (100-pct).toFixed(1) + '%';
    }
    setInterval(update,1000); update();
  <\/script></body></html>`;
  const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=1000,height=500');
  w.document.write(html); w.document.close();
}

function updateAll(){
  const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
  state.timers.forEach(timer=>{
    const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
    let since = (nowMin - timer.s + 1440) % 1440; if(since>dur) since = dur;
    const pct = clamp((since/dur)*100,0,100);
    const fill = document.getElementById(timer.id + '_fill'); if(fill){ fill.style.width = pct + '%'; fill.style.height = timer.height + 'px'; }
    const left = document.getElementById(timer.id + '_left'); const right = document.getElementById(timer.id + '_right');
    if(left) left.textContent = pct.toFixed(1) + '%'; if(right) right.textContent = (100-pct).toFixed(1) + '%';
    const goneEl = document.getElementById(timer.id + '_gone'); const leftEl = document.getElementById(timer.id + '_leftmin');
    const minsGone = Math.floor(Math.max(0, since)); const minsLeft = Math.ceil(Math.max(0, dur - since));
    if(goneEl) goneEl.textContent = minsGone + ' min gone'; if(leftEl) leftEl.textContent = minsLeft + ' min left';
    const barEl = document.getElementById(timer.id + '_bar');
    if(barEl) renderAgendas(timer, barEl);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

document.getElementById('addTimer').addEventListener('click', addTimerFromForm);
document.getElementById('saveBtn').addEventListener('click', saveState);
document.getElementById('loadBtn').addEventListener('click', loadState);
document.getElementById('clearBtn').addEventListener('click', clearAll);

setInterval(updateAll,1000);

if(!localStorage.getItem('linearTimersV2')){
  state.timers.push({
    id: uid('t'), name: 'Example Period', start: '07:20', end: '08:10', s: timeToMinutes('07:20'), e: timeToMinutes('08:10'),
    color:'#3b82f6', height:36, agenda:[ { id: uid('a'), label:'Do Now', duration:10, color:'#f97316', offsetPct:5 } ]
  });
  renderAll();
} else {
  loadState();
}

window.state = state;
window.renderAll = renderAll;
</script>
</body>
</html>
